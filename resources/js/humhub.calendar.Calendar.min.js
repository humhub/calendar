humhub.module("calendar.Calendar",function(e,c,b){var n=c("ui.widget").Widget,l=c("client"),p=c("util").string,m=c("ui.loader"),q=c("ui.view"),g=c("ui.modal");c=n.extend();c.prototype.init=function(){var a=this;this.options.events=function(f,d,k){b.ajax({url:a.options.loadUrl,type:"GET",data:{start:moment(f.start.valueOf()).format("YYYY-MM-DD"),end:moment(f.end.valueOf()).format("YYYY-MM-DD"),selectors:a.options.selectors,filters:a.options.filters},success:function(h){d(h)}})};e.log.debug("Init calendar: ",
    this.options);this.initCalendarFilter();this.updateCalendarFilters()};c.prototype.initCalendarFilter=function(){var a=this;b(".selectorCheckbox").click(function(){a.updateCalendarFilters(!0)});b(".filterCheckbox").click(function(){"3"==b(this).val()&&b(":checkbox[value=4][name='filter']").attr("checked",!1);"4"==b(this).val()&&b(":checkbox[value=3][name='filter']").attr("checked",!1);a.updateCalendarFilters(!0)})};c.prototype.updateCalendarFilters=function(a){var f=this;this.options.selectors=[];
    this.options.filters=[];b(".selectorCheckbox").each(function(){b(this).prop("checked")&&f.options.selectors.push(b(this).val())});b(".filterCheckbox").each(function(){b(this).prop("checked")&&f.options.filters.push(b(this).val())});this.initFullCalendar(a)};c.prototype.initFullCalendar=function(a){this.fullCalendar&&a?(this.fullCalendar.removeAllEventSources(),this.fullCalendar.addEventSource(this.options.events)):(this.fullCalendar=new FullCalendar.Calendar(this.$[0],this.options),this.fullCalendar.render())};
    c.prototype.getDefaultOptions=function(){var a={};"today"!==e.text("button.today")&&(a.today=e.text("button.today"));"month"!==e.text("button.month")&&(a.month=e.text("button.month"));"week"!==e.text("button.week")&&(a.week=e.text("button.week"));"day"!==e.text("button.day")&&(a.day=e.text("button.day"));"list"!==e.text("button.list")&&(a.list=e.text("button.list"));a={header:{left:"prev,next today",center:"title",right:"dayGridMonth,timeGridWeek,timeGridDay,listWeek"},buttonText:a,plugins:"dayGrid timeGrid list interaction bootstrap moment momentTimezone".split(" "),
        defaultView:"dayGridMonth",canCreate:!0,selectable:!0,select:b.proxy(this.select,this),eventAllow:function(){return!0},themeSystem:"bootstrap",loading:b.proxy(this.loader,this),eventResize:b.proxy(this.updateEvent,this),eventDrop:b.proxy(this.updateEvent,this),eventClick:b.proxy(this.clickEvent,this),eventRender:b.proxy(this.renderEvent,this)};q.isSmall()&&(a.header={left:"prev,next",center:"title",right:"today"},a.footer={center:"dayGridMonth,timeGridWeek,timeGridDay,listWeek"});return a};c.prototype.renderEvent=
        function(a,f){var d=b(f);d.attr({title:d.text()});a.icon&&p.startsWith(a.icon,"fa-")&&d.find(".fc-content").prepend(b('<i class="fa '+a.icon+'"></i>'))};c.prototype.toJsonDateFormat=function(a,f){return f?FullCalendarMoment.toMoment(a,this.fullCalendar).format("YYYY-MM-DD"):FullCalendarMoment.toMoment(a,this.fullCalendar).format()};c.prototype.select=function(a){var f=this;a={data:{start:this.toJsonDateFormat(a.start,!1),end:this.toJsonDateFormat(a.end,!1),cal:1}};g.global.load(this.options.global?
        this.options.globalCreateUrl:this.options.editUrl,a).then(function(){g.global.$.one("hidden.bs.modal submitted",function(){f.fetch()})})["catch"](function(d){g.global.close();e.log.error(d,!0)});this.fullCalendar.unselect()};c.prototype.fetch=function(){this.fullCalendar.refetchEvents()};c.prototype.updateEvent=function(a){var f=this,d=a.event,k=d.extendedProps;d={data:{id:d.id,start:this.toJsonDateFormat(d.start,d.allDay),end:this.toJsonDateFormat(d.end,d.allDay)}};this.loader();l.post(k.updateUrl,
        d).then(function(h){h.success?e.log.success("saved"):e.log.error(h,!0);k.refreshAfterUpdate&&f.fetch()})["catch"](function(h){e.log.error(h,!0);a.revert()})["finally"](function(){f.loader(!1)})};c.prototype.clickEvent=function(a){a=a.event.extendedProps;if(a.viewUrl){var f=this;"modal"===a.viewMode?g.global.load(a.viewUrl,{viewContext:"fullCalendar"}).then(function(){g.global.set({backdrop:!0});g.global.$.one("hidden.bs.modal",function(){f.fetch()})})["catch"](function(d){e.log.error(d,!0);g.global.close()}):
        l.pjax.redirect(a.viewUrl)}};c.prototype.loader=function(a){!1===a?m.reset(b("#calendar-overview-loader")):m.set(b("#calendar-overview-loader"),{size:"8px",css:{padding:"2px ",width:"60px"}})};e["export"]=c});