humhub.module("calendar.Calendar",function(t,e,o){var n=e("ui.widget").Widget,i=e("client"),a=e("util").string,r=e("ui.loader"),l=e("ui.view"),s=e("ui.modal"),d=n.extend();d.prototype.init=function(){var e=this;this.options.events=function(t,n,i){o.ajax({url:e.options.loadUrl,type:"GET",data:{start:moment(t.start.valueOf()).format("YYYY-MM-DD"),end:moment(t.end.valueOf()).format("YYYY-MM-DD"),selectors:e.options.selectors,filters:e.options.filters,types:e.options.types},success:function(t){n(t)}})},t.log.debug("Init calendar: ",this.options),this.initCalendarFilter(),this.updateCalendarFilters()},d.prototype.initCalendarFilter=function(){var t=this;o(".selectorCheckbox").click(function(){t.updateCalendarFilters(!0)}),o(".filterCheckbox").click(function(){"3"==o(this).val()&&o(":checkbox[value=4][name='filter']").attr("checked",!1),"4"==o(this).val()&&o(":checkbox[value=3][name='filter']").attr("checked",!1),t.updateCalendarFilters(!0)}),o('select[name="filterType[]"]').on("change.select2",function(){t.updateCalendarFilters(!0)})},d.prototype.updateCalendarFilters=function(t){var e=this;this.options.selectors=[],this.options.filters=[],this.options.types=[],o(".selectorCheckbox").each(function(){o(this).prop("checked")&&e.options.selectors.push(o(this).val())}),o(".filterCheckbox").each(function(){o(this).prop("checked")&&e.options.filters.push(o(this).val())}),e.options.types=o('select[name="filterType[]"]').val(),this.initFullCalendar(t)},d.prototype.initFullCalendar=function(t){this.fullCalendar&&t?(this.fullCalendar.removeAllEventSources(),this.fullCalendar.addEventSource(this.options.events)):(this.fullCalendar=new FullCalendar.Calendar(this.$[0],this.options),this.fullCalendar.render())},d.prototype.getDefaultOptions=function(){var e={};"today"!==t.text("button.today")&&(e.today=t.text("button.today")),"month"!==t.text("button.month")&&(e.month=t.text("button.month")),"week"!==t.text("button.week")&&(e.week=t.text("button.week")),"day"!==t.text("button.day")&&(e.day=t.text("button.day")),"list"!==t.text("button.list")&&(e.list=t.text("button.list"));var n=this,i={customButtons:{create:{click:function(){var e=new Date;e.setHours(e.getHours()+1),e.setMinutes(0,0,0);var o=new Date;o.setHours(o.getHours()+2),o.setMinutes(0,0,0);var i={data:{start:n.toJsonDateFormat(e,!1),end:n.toJsonDateFormat(o,!1),cal:1}},a=n.options.global?n.options.globalCreateUrl:n.options.editUrl;s.global.load(a,i).then(function(){s.global.$.one("hidden.bs.modal submitted",function(){n.fetch()})}).catch(function(e){s.global.close(),t.log.error(e,!0)}),n.fullCalendar.unselect()},bootstrapFontAwesome:"fa-plus"}},header:{left:"prev,next today",center:"title",right:"create dayGridMonth,timeGridWeek,timeGridDay,listMonth"},buttonText:e,plugins:["dayGrid","timeGrid","list","interaction","bootstrap","moment","momentTimezone"],defaultView:"dayGridMonth",canCreate:!0,selectable:!0,select:o.proxy(this.select,this),eventAllow:function(){return!0},themeSystem:"bootstrap",loading:o.proxy(this.loader,this),eventResize:o.proxy(this.updateEvent,this),eventDrop:o.proxy(this.updateEvent,this),eventClick:o.proxy(this.clickEvent,this),eventRender:o.proxy(this.renderEvent,this)};return l.isSmall()&&(i.header={left:"prev,next",center:"title",right:"today"},i.footer={center:"dayGridMonth,timeGridWeek,timeGridDay,listMonth",right:"create"}),i},d.prototype.renderEvent=function(t,e){var n=o(e);n.attr({title:n.text()}),t.icon&&a.startsWith(t.icon,"fa-")&&n.find(".fc-content").prepend(o('<i class="fa '+t.icon+'"></i>'))},d.prototype.toJsonDateFormat=function(t,e){return e?FullCalendarMoment.toMoment(t,this.fullCalendar).format("YYYY-MM-DD"):FullCalendarMoment.toMoment(t,this.fullCalendar).format()},d.prototype.select=function(e){var o=this,n={data:{start:this.toJsonDateFormat(e.start,!1),end:this.toJsonDateFormat(e.end,!1),cal:1}};"dayGridMonth"===e.view.type&&(n.data.view="month");var i=this.options.global?this.options.globalCreateUrl:this.options.editUrl;s.global.load(i,n).then(function(){s.global.$.one("hidden.bs.modal submitted",function(){o.fetch()})}).catch(function(e){s.global.close(),t.log.error(e,!0)}),this.fullCalendar.unselect()},d.prototype.fetch=function(){this.fullCalendar.refetchEvents()},d.prototype.updateEvent=function(e){var o=this,n=e.event,a=n.extendedProps,r={data:{id:n.id,start:this.toJsonDateFormat(n.start,n.allDay),end:this.toJsonDateFormat(n.end,n.allDay)}};this.loader(),i.post(a.updateUrl,r).then(function(e){e.success?t.log.success("saved"):t.log.error(e,!0),a.refreshAfterUpdate&&o.fetch()}).catch(function(o){t.log.error(o,!0),e.revert()}).finally(function(){o.loader(!1)})},d.prototype.clickEvent=function(e){var o=e.event.extendedProps;if(o.viewUrl){var n=this;"modal"===o.viewMode?s.global.load(o.viewUrl,{viewContext:"fullCalendar"}).then(function(){s.global.set({backdrop:!0}),s.global.$.one("hidden.bs.modal",function(){n.fetch()})}).catch(function(e){t.log.error(e,!0),s.global.close()}):i.pjax.redirect(o.viewUrl)}},d.prototype.loader=function(t){!1===t?r.reset(o("#calendar-overview-loader")):r.set(o("#calendar-overview-loader"),{size:"8px",css:{padding:"2px ",width:"60px"}})},t.export=d});