/**
 * @link https://www.humhub.org/
 * @copyright Copyright (c) 2017 HumHub GmbH & Co. KG
 * @license https://www.humhub.com/licences
 */ humhub.module("calendar",function(t,n,o){var r=n("ui.widget").Widget,i=n("client"),a=n("ui.modal"),c=n("action"),d=n("content").Content,l=n("event"),s=n("stream").StreamEntry,u=n("ui.status"),f=r.extend(),p=r.extend();p.RECUR_EDIT_MODE_CREATE=0,p.RECUR_EDIT_MODE_THIS=1,p.RECUR_EDIT_MODE_FOLLOWING=2,p.RECUR_EDIT_MODE_ALL=3,p.prototype.init=function(){a.global.$.find(".tab-basic").on("shown.bs.tab",function(t){o("#calendarentry-title").focus()}),a.global.$.find(".tab-participation").on("shown.bs.tab",function(t){o("#calendarentry-participation_mode").focus()}),this.initDateTimeCorrector(),this.initTimeInput(),this.initSubmitAction()},p.prototype.initDateTimeCorrector=function(){var t="#calendarentryform-start_",n="#calendarentryform-end_",r=function(t){var n=parseInt((t=t.split(":"))[0]);return 12===n&&t[1].includes("AM")?n=0:n+=t[1].includes("PM")&&n<12?12:0,60*n+parseInt(t[1])},i=function(t,n){var o=t%60,r=(t-o)/60,i="";return"12h"===n&&(i=r<12?" AM":" PM",0===r?r=12:r>12&&(r-=12)),r<10&&(r="0"+r),o<10&&(o="0"+o),r+":"+o+i},a=function(){return{start:o(t+"date").datepicker("getDate").getTime(),end:o(n+"date").datepicker("getDate").getTime()}},c=function(t,n,r){if(n<0||n>=1440){var a=new Date(o(t+"date").datepicker("getDate"));a.setDate(a.getDate()+(n<0?-1:1)),o(t+"date").datepicker("setDate",a),n+=n<0?1440:-1440}o(t+"time").val(i(n,r))},d=function(){var i=a();if(i.start!==i.end)return!0;var c={start:r(o(t+"time").val()),end:r(o(n+"time").val()),mode:o(t+"time").val().includes("M")?"12h":"24h"};return!(c.start>=c.end)||c};this.$.find(t+"time").on("change",function(){var t=d();!0!==t&&c(n,t.start+60,t.mode)}),this.$.find(n+"time").on("change",function(){var n=d();!0!==n&&c(t,n.end-60,n.mode)});var l=function(){var t=a();return t.start<=t.end};this.$.find(t+"date").on("change",function(){l()||o(n+"date").val(o(t+"date").val())}),this.$.find(n+"date").on("change",function(){l()||o(t+"date").val(o(n+"date").val())})},p.prototype.setEditMode=function(t){var n=t.$trigger.data("editMode");n==p.RECUR_EDIT_MODE_THIS?o(".field-calendarentryform-is_public").hide():o(".field-calendarentryform-is_public").show(),this.$.find(".calendar-edit-mode-back").show(),this.$.find(".recurrence-edit-type").hide(),this.$.find(".calendar-entry-form-tabs").show(),this.$.find("#recurrenceEditMode").val(n)},p.prototype.showEditModes=function(t){this.$.find(".calendar-edit-mode-back").hide(),this.$.find(".recurrence-edit-type").show(),this.$.find(".calendar-entry-form-tabs").hide()},p.prototype.initTimeInput=function(){a.global.$.find(".timeField").find(".form-control").each(function(){var t=o(this);t.prop("disabled")&&t.data("oldVal",t.val()).val("")})},p.prototype.initSubmitAction=function(){a.global.$.one("submitted",h)};var h=function(t,n){n.id&&a.global.$.one("hidden.bs.modal",function(){var t=s.getNodeByKey(n.id);t.length&&(t=new s(t)).reload()}),n.reloadWall?(l.trigger("humhub:content:newEntry",n.content,this),l.trigger("humhub:content:afterSubmit",n.content,this)):a.global.$.one("submitted",h)};p.prototype.toggleDateTime=function(t){var n=a.global.$.find(".timeField"),r=n.find(".form-control"),i=a.global.$.find(".timeZoneField");t.$trigger.prop("checked")?(r.prop("disabled",!0),r.each(function(){o(this).data("oldVal",o(this).val()).val("")}),n.css("opacity","0.2"),i.hide()):(r.each(function(){var t=o(this);t.data("oldVal")&&t.val(t.data("oldVal"))}),r.prop("disabled",!1),n.css("opacity","1.0"),i.show())},p.prototype.changeTimezone=function(t){var n=this.$.find(".timeZoneInput");this.$.find(".calendar-timezone").text(n.find("option:selected").text()),n.hide()},p.prototype.toggleTimezoneInput=function(t){this.$.find(".timeZoneInput").fadeToggle()},p.prototype.changeEventType=function(n){var r=n.$trigger.find(":selected");r.data("color")?(o(".colorpicker-element").data("colorpicker").color.setColor(r.data("color")),o(".colorpicker-element").data("colorpicker").update()):t.config.defaultEventColor&&(o(".colorpicker-element").data("colorpicker").color.setColor(t.config.defaultEventColor),o(".colorpicker-element").data("colorpicker").update())},p.prototype.toggleRecurring=function(t){o(".calendar-entry-form-tabs .tab-recurrence").parent().toggle(t.$trigger.is(":checked"))},p.prototype.toggleReminder=function(t){o(".calendar-entry-form-tabs .tab-reminder").parent().toggle(t.$trigger.is(":checked"))};var g=d.extend();g.prototype.toggleClose=function(t){this.update(i.post(t))},g.prototype.reload=function(t){return this.parent().reload()},g.prototype.update=function(t){this.loader(),t.then(o.proxy(this.handleUpdateSuccess,this)).catch(g.handleUpdateError).finally(o.proxy(this.loader,this,!1))},g.prototype.loader=function(t){this.streamEntry().loader(t)},g.prototype.handleUpdateSuccess=function(n){return this.streamEntry().replace(n.output).catch(function(n){t.log.error(n,!0)})},g.handleUpdateError=function(n){t.log.error(n,!0)},g.prototype.streamEntry=function(){return this.parent()};var m=function(n){n.block=c.BLOCK_MANUAL,i.post(n).then(function(o){o.success?r.closest(n.$trigger).reload().then(function(){t.log.success("saved")}):(t.log.error(e,!0),n.finish())}).catch(function(o){t.log.error(o,!0),n.finish()})},y=function(n){a.load(n).then(function(t){a.global.$.one("submitted",function(){var t=v();t&&t.fetch()})}).catch(function(n){t.log.error(n,!0)})},v=function(){return r.instance("#calendar")},b=function(n){r.closest(n.$trigger).loader(),a.confirm().then(function(o){o?i.post(n).then(function(t){t.success?(u.success(t.message),a.global.close()):t.message&&u.error(t.message)}).catch(function(n){t.log.error(n,!0),n.message&&u.error(n.message)}):r.closest(n.$trigger).loader(!1)}).finally(function(){n.finish()})};t.export({Calendar:f,respond:m,editModal:y,deleteEvent:b,CalendarEntry:g,Form:p})});