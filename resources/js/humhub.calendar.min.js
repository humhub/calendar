humhub.module("calendar",function(o,t,l){var i=t("ui.widget").Widget,a=t("client"),r=t("ui.modal"),d=t("action"),n=t("content").Content,c=t("event"),s=t("stream").StreamEntry,u=t("ui.status"),f=i.extend(),p=i.extend();p.RECUR_EDIT_MODE_CREATE=0,p.RECUR_EDIT_MODE_THIS=1,p.RECUR_EDIT_MODE_FOLLOWING=2,p.RECUR_EDIT_MODE_ALL=3,p.prototype.init=function(){r.global.$.find(".tab-basic").on("shown.bs.tab",function(t){l("#calendarentry-title").focus()}),r.global.$.find(".tab-participation").on("shown.bs.tab",function(t){l("#calendarentry-participation_mode").focus()}),this.initDateTimeCorrector(),this.initTimeInput(),this.initSubmitAction()},p.prototype.initDateTimeCorrector=function(){function n(t){t=t.split(":");var e=parseInt(t[0]);return 12===e&&t[1].includes("AM")?e=0:e+=t[1].includes("PM")&&e<12?12:0,60*e+parseInt(t[1])}function o(){return{start:l(a+"date").datepicker("getDate").getTime(),end:l(r+"date").datepicker("getDate").getTime()}}function e(t,e,n){var o,i,a,r,d=1440;if(e<0||d<=e){var c=new Date(l(t+"date").datepicker("getDate"));c.setDate(c.getDate()+(e<0?-1:1)),l(t+"date").datepicker("setDate",c),e+=e<0?d:-d}l(t+"time").val((a=((o=e)-(i=o%60))/60,r="","12h"===n&&(r=a<12?" AM":" PM",0===a?a=12:12<a&&(a-=12)),a<10&&(a="0"+a),i<10&&(i="0"+i),a+":"+i+r))}function i(){var t=o();if(t.start!==t.end)return!0;var e={start:n(l(a+"time").val()),end:n(l(r+"time").val()),mode:l(a+"time").val().includes("M")?"12h":"24h"};return!(e.end<=e.start)||e}var a="#calendarentryform-start_",r="#calendarentryform-end_";this.$.find(a+"time").on("change",function(){var t=i();!0!==t&&e(r,t.start+60,t.mode)}),this.$.find(r+"time").on("change",function(){var t=i();!0!==t&&e(a,t.end-60,t.mode)});function t(){var t=o();return t.start<=t.end}this.$.find(a+"date").on("change",function(){t()||l(r+"date").val(l(a+"date").val())}),this.$.find(r+"date").on("change",function(){t()||l(a+"date").val(l(r+"date").val())})},p.prototype.setEditMode=function(t){var e=t.$trigger.data("editMode");l(".field-calendarentryform-is_public").toggleClass("d-none",e==p.RECUR_EDIT_MODE_THIS),this.$.find(".calendar-edit-mode-back").removeClass("d-none"),this.$.find(".recurrence-edit-type").addClass("d-none"),this.$.find(".calendar-entry-form-tabs").removeClass("d-none"),this.$.find("#recurrenceEditMode").val(e)},p.prototype.showEditModes=function(){this.$.find(".calendar-edit-mode-back").addClass("d-none"),this.$.find(".recurrence-edit-type").removeClass("d-none"),this.$.find(".calendar-entry-form-tabs").addClass("d-none")},p.prototype.initTimeInput=function(){r.global.$.find(".timeField").find(".form-control").each(function(){var t=l(this);t.prop("disabled")&&t.data("oldVal",t.val()).val("")})},p.prototype.initSubmitAction=function(){r.global.$.one("submitted",h)};var h=function(t,e){e.id&&r.global.$.one("hidden.bs.modal",function(){var t=s.getNodeByKey(e.id);t.length&&(t=new s(t)).reload()}),e.reloadWall?(c.trigger("humhub:content:newEntry",e.content,this),c.trigger("humhub:content:afterSubmit",e.content,this)):r.global.$.one("submitted",h)};p.prototype.toggleDateTime=function(t){var e=r.global.$.find(".timeField"),n=e.find(".form-control"),o=r.global.$.find(".timeZoneField");t.$trigger.prop("checked")?(n.prop("disabled",!0),n.each(function(){l(this).data("oldVal",l(this).val()).val("")}),e.css("opacity","0.2"),o.hide()):(n.each(function(){var t=l(this);t.data("oldVal")&&t.val(t.data("oldVal"))}),n.prop("disabled",!1),e.css("opacity","1.0"),o.show())},p.prototype.changeTimezone=function(t){var e=this.$.find(".timeZoneInput");this.$.find(".calendar-timezone").text(e.find("option:selected").text()),e.hide()},p.prototype.toggleTimezoneInput=function(t){this.$.find(".timeZoneInput").fadeToggle()},p.prototype.changeEventType=function(t){var e=t.$trigger.find(":selected");e.data("color")?this.$.find("#calendarentry-color").val(e.data("color")):o.config.defaultEventColor&&this.$.find("#calendarentry-color").val(o.config.defaultEventColor)},p.prototype.toggleRecurring=function(t){l(".calendar-entry-form-tabs .tab-recurrence").toggleClass("d-none",!t.$trigger.is(":checked"))},p.prototype.toggleReminder=function(t){l(".calendar-entry-form-tabs .tab-reminder").toggleClass("d-none",!t.$trigger.is(":checked"))};var g=n.extend();g.prototype.toggleClose=function(t){this.update(a.post(t))},g.prototype.reload=function(t){return this.parent().reload()},g.prototype.update=function(t){this.loader(),t.then(l.proxy(this.handleUpdateSuccess,this)).catch(g.handleUpdateError).finally(l.proxy(this.loader,this,!1))},g.prototype.loader=function(t){this.streamEntry().loader(t)},g.prototype.handleUpdateSuccess=function(t){return this.streamEntry().replace(t.output).catch(function(t){o.log.error(t,!0)})},g.handleUpdateError=function(t){o.log.error(t,!0)},g.prototype.streamEntry=function(){return this.parent()};var m=function(){return i.instance("#calendar")};o.export({Calendar:f,respond:function(n){n.block=d.BLOCK_MANUAL,a.post(n).then(function(t){t.success?i.closest(n.$trigger).reload().then(function(){o.log.success("saved")}):(o.log.error(e,!0),n.finish())}).catch(function(t){o.log.error(t,!0),n.finish()})},editModal:function(t){r.load(t).then(function(t){r.global.$.one("submitted",function(){var t=m();t&&t.fetch()})}).catch(function(t){o.log.error(t,!0)})},deleteEvent:function(e){i.closest(e.$trigger).loader(),r.confirm().then(function(t){t?a.post(e).then(function(t){t.success?(u.success(t.message),r.global.close()):t.message&&u.error(t.message)}).catch(function(t){o.log.error(t,!0),t.message&&u.error(t.message)}):i.closest(e.$trigger).loader(!1)}).finally(function(){e.finish()})},CalendarEntry:g,Form:p})});